openapi: 3.0.3
info:
  title: Admin Orders API
  description: |
    API for administrators to manage orders across all tenants. Provides enhanced
    access for order management, status updates, notes, refunds, and exports.
    Requires admin authentication and appropriate permissions.
  version: 1.0.0
  contact:
    name: eCommerce SaaS API Team
    email: api@ecommerce-saas.com

servers:
  - url: http://localhost:5173/api/v1
    description: Development server with MSW mocks
  - url: https://api.ecommerce-saas.com/api/v1
    description: Production server (future)

tags:
  - name: Admin Orders
    description: Administrative order management operations

paths:
  /admin/orders:
    get:
      summary: Get all orders (admin view)
      description: |
        Retrieves paginated list of orders across all tenants with advanced filtering
        and search capabilities. Administrators can filter by tenant, status, customer,
        date range, and search by order number or customer email.
      operationId: getAdminOrders
      tags:
        - Admin Orders
      parameters:
        - name: tenantId
          in: query
          description: Filter by tenant ID
          required: false
          schema:
            type: string
            format: uuid
          example: demo-tenant
        - name: status
          in: query
          description: Filter by order status
          required: false
          schema:
            type: string
            enum:
              - new
              - submitted
              - paid
              - completed
              - cancelled
          example: paid
        - name: customerId
          in: query
          description: Filter by customer ID
          required: false
          schema:
            type: string
            format: uuid
          example: customer-123
        - name: dateFrom
          in: query
          description: Filter orders created after this date (ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
          example: '2025-10-01T00:00:00Z'
        - name: dateTo
          in: query
          description: Filter orders created before this date (ISO 8601)
          required: false
          schema:
            type: string
            format: date-time
          example: '2025-10-31T23:59:59Z'
        - name: searchTerm
          in: query
          description: Search by order number or customer email
          required: false
          schema:
            type: string
          example: DEMO-000001
        - name: page
          in: query
          description: Page number (1-indexed)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          description: Number of results per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          example: 50
        - name: sortBy
          in: query
          description: Field to sort by
          required: false
          schema:
            type: string
            enum:
              - createdAt
              - updatedAt
              - total
              - orderNumber
            default: createdAt
          example: createdAt
        - name: sortOrder
          in: query
          description: Sort order
          required: false
          schema:
            type: string
            enum:
              - asc
              - desc
            default: desc
          example: desc
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderListResponse'
              example:
                orders:
                  - id: order-123e4567-e89b-12d3-a456-426614174000
                    tenantId: demo-tenant
                    tenantName: Demo Store
                    customerId: customer-123
                    customerEmail: john@example.com
                    orderNumber: DEMO-000001
                    status: completed
                    total: 103.16
                    currency: USD
                    isGuest: false
                    createdAt: '2025-10-20T10:00:00Z'
                    submittedAt: '2025-10-20T10:30:00Z'
                    completedAt: '2025-10-21T15:30:00Z'
                    itemCount: 2
                  - id: order-987e6543-e21b-12d3-a456-426614174000
                    tenantId: test-tenant
                    tenantName: Test Store
                    customerId: customer-456
                    customerEmail: jane@example.com
                    orderNumber: TEST-000001
                    status: paid
                    total: 152.98
                    currency: USD
                    isGuest: false
                    createdAt: '2025-10-22T08:00:00Z'
                    submittedAt: '2025-10-22T08:15:00Z'
                    itemCount: 3
                totalCount: 2
                page: 1
                limit: 50
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/orders/{orderId}:
    get:
      summary: Get order details (admin view)
      description: |
        Retrieves full order details with admin-specific information including
        internal notes, full payment details, and complete audit trail.
        More data than customer-facing order details endpoint.
      operationId: getAdminOrderDetails
      tags:
        - Admin Orders
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Order details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderDetail'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                tenantId: demo-tenant
                tenantName: Demo Store
                customerId: customer-123
                customerEmail: john@example.com
                customerName: John Doe
                orderNumber: DEMO-000001
                status: completed
                subtotal: 89.97
                tax: 7.20
                shipping: 5.99
                discount: 0
                total: 103.16
                currency: USD
                isGuest: false
                createdAt: '2025-10-20T10:00:00Z'
                updatedAt: '2025-10-21T15:30:00Z'
                submittedAt: '2025-10-20T10:30:00Z'
                completedAt: '2025-10-21T15:30:00Z'
                lineItems:
                  - id: item-123
                    productId: prod-001
                    productName: Wireless Mouse
                    productSKU: WM-001
                    quantity: 2
                    unitPrice: 29.99
                    lineTotal: 59.98
                shippingAddress:
                  firstName: John
                  lastName: Doe
                  addressLine1: 123 Main St
                  city: San Francisco
                  state: CA
                  postalCode: '94102'
                  country: US
                  phone: '+14155551234'
                statusHistory:
                  - fromStatus: null
                    toStatus: new
                    timestamp: '2025-10-20T10:00:00Z'
                  - fromStatus: new
                    toStatus: submitted
                    timestamp: '2025-10-20T10:30:00Z'
                  - fromStatus: submitted
                    toStatus: paid
                    timestamp: '2025-10-20T10:31:00Z'
                  - fromStatus: paid
                    toStatus: completed
                    timestamp: '2025-10-21T15:30:00Z'
                    userId: admin-123
                    userEmail: admin@demo.com
                    notes: Order fulfilled and shipped via UPS
                transactions:
                  - id: txn-123
                    amount: 103.16
                    paymentMethod: credit_card
                    paymentProvider: stripe
                    transactionId: ch_mock_12345
                    status: success
                    type: charge
                    createdAt: '2025-10-20T10:31:00Z'
                adminNotes:
                  - id: note-1
                    userId: admin-123
                    userEmail: admin@demo.com
                    note: Customer requested expedited shipping
                    createdAt: '2025-10-20T11:00:00Z'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Order with ID order-999 not found
                statusCode: 404
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/orders/{orderId}/status:
    put:
      summary: Update order status (admin action)
      description: |
        Updates the order status with admin override capability. Creates status
        history entry with admin user information and optional notes. Validates
        status transitions but allows admin overrides for exceptional cases.
      operationId: updateOrderStatus
      tags:
        - Admin Orders
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrderStatusRequest'
            example:
              status: completed
              notes: Order fulfilled and shipped via UPS tracking 1Z999AA10123456784
      responses:
        '200':
          description: Order status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderDetail'
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Invalid status transition from 'completed' to 'paid'
                statusCode: 400
                details:
                  currentStatus: completed
                  requestedStatus: paid
                  validTransitions: []
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/orders/{orderId}/notes:
    post:
      summary: Add admin note to order
      description: |
        Adds an internal admin note to the order for tracking purposes.
        Notes are not visible to customers.
      operationId: addOrderNote
      tags:
        - Admin Orders
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddOrderNoteRequest'
            example:
              note: Customer called to request address change. Updated shipping address and re-processed order.
      responses:
        '200':
          description: Note added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderDetail'
        '400':
          description: Invalid note (empty or too long)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Note cannot be empty
                statusCode: 400
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/orders/{orderId}/refund:
    post:
      summary: Process refund
      description: |
        Processes a full or partial refund for an order. Creates a refund
        transaction and optionally updates order status to 'cancelled'.
        Validates refund amount against paid transactions.
      operationId: processRefund
      tags:
        - Admin Orders
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
            examples:
              fullRefund:
                summary: Full refund including shipping
                value:
                  amount: 103.16
                  reason: Customer requested cancellation
                  refundShipping: true
              partialRefund:
                summary: Partial refund (one item)
                value:
                  amount: 29.99
                  reason: Defective product
                  refundShipping: false
      responses:
        '200':
          description: Refund processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderDetail'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                status: cancelled
                transactions:
                  - id: txn-123
                    amount: 103.16
                    status: success
                    type: charge
                    createdAt: '2025-10-20T10:31:00Z'
                  - id: txn-456
                    amount: 103.16
                    status: success
                    type: refund
                    createdAt: '2025-10-22T14:00:00Z'
        '400':
          description: Invalid refund amount or order not paid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notPaid:
                  summary: Order not paid
                  value:
                    error: Bad Request
                    message: Cannot refund order that has not been paid
                    statusCode: 400
                    details:
                      currentStatus: submitted
                amountTooHigh:
                  summary: Refund amount exceeds paid amount
                  value:
                    error: Bad Request
                    message: Refund amount ($150.00) exceeds paid amount ($103.16)
                    statusCode: 400
                    details:
                      requestedAmount: 150.00
                      paidAmount: 103.16
                      availableRefund: 103.16
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/orders/export:
    get:
      summary: Export orders as CSV/Excel
      description: |
        Exports filtered orders to CSV or Excel format for reporting and analysis.
        Supports same filtering parameters as order list endpoint.
      operationId: exportOrders
      tags:
        - Admin Orders
      parameters:
        - name: tenantId
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum:
              - new
              - submitted
              - paid
              - completed
              - cancelled
        - name: dateFrom
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: dateTo
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: format
          in: query
          description: Export format
          required: false
          schema:
            type: string
            enum:
              - csv
              - xlsx
            default: csv
          example: csv
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Export file generated successfully
          content:
            text/csv:
              schema:
                type: string
                format: binary
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with admin role

  schemas:
    AdminOrderListResponse:
      type: object
      description: Paginated list of orders (admin view)
      required:
        - orders
        - totalCount
        - page
        - limit
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/AdminOrderSummary'
        totalCount:
          type: integer
          minimum: 0
        page:
          type: integer
          minimum: 1
        limit:
          type: integer
          minimum: 1

    AdminOrderSummary:
      type: object
      description: Order summary (admin view) with tenant and customer info
      required:
        - id
        - tenantId
        - tenantName
        - customerId
        - customerEmail
        - orderNumber
        - status
        - total
        - currency
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
        tenantName:
          type: string
        customerId:
          type: string
          format: uuid
        customerEmail:
          type: string
          format: email
        orderNumber:
          type: string
        status:
          $ref: '#/components/schemas/OrderStatus'
        total:
          type: number
          format: double
        currency:
          type: string
        isGuest:
          type: boolean
        createdAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        cancelledAt:
          type: string
          format: date-time
        itemCount:
          type: integer
          description: Number of line items in order

    AdminOrderDetail:
      type: object
      description: Full order details (admin view)
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
        tenantName:
          type: string
        customerId:
          type: string
          format: uuid
        customerEmail:
          type: string
          format: email
        customerName:
          type: string
        orderNumber:
          type: string
        status:
          $ref: '#/components/schemas/OrderStatus'
        subtotal:
          type: number
          format: double
        tax:
          type: number
          format: double
        shipping:
          type: number
          format: double
        discount:
          type: number
          format: double
        total:
          type: number
          format: double
        currency:
          type: string
        isGuest:
          type: boolean
        guestEmail:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        cancelledAt:
          type: string
          format: date-time
        cancellationReason:
          type: string
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/OrderLineItem'
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/BillingAddress'
        statusHistory:
          type: array
          items:
            $ref: '#/components/schemas/OrderStatusHistory'
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/PaymentTransaction'
        adminNotes:
          type: array
          items:
            $ref: '#/components/schemas/AdminNote'

    OrderLineItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        productId:
          type: string
          format: uuid
        productName:
          type: string
        productSKU:
          type: string
        productImage:
          type: string
          format: uri
        quantity:
          type: integer
        unitPrice:
          type: number
          format: double
        lineTotal:
          type: number
          format: double
        currency:
          type: string

    Address:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        company:
          type: string
        addressLine1:
          type: string
        addressLine2:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string
        phone:
          type: string

    BillingAddress:
      allOf:
        - $ref: '#/components/schemas/Address'
        - type: object
          properties:
            sameAsShipping:
              type: boolean

    OrderStatusHistory:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        fromStatus:
          $ref: '#/components/schemas/OrderStatus'
        toStatus:
          $ref: '#/components/schemas/OrderStatus'
        timestamp:
          type: string
          format: date-time
        userId:
          type: string
          format: uuid
        userEmail:
          type: string
          format: email
        notes:
          type: string

    PaymentTransaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        amount:
          type: number
          format: double
        currency:
          type: string
        paymentMethod:
          type: string
        paymentProvider:
          type: string
        transactionId:
          type: string
        status:
          type: string
          enum:
            - pending
            - success
            - failed
            - refunded
        type:
          type: string
          enum:
            - charge
            - refund
        failureReason:
          type: string
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time

    AdminNote:
      type: object
      description: Admin note attached to order
      required:
        - id
        - userId
        - userEmail
        - note
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
          description: Admin user who created the note
        userEmail:
          type: string
          format: email
          description: Email of admin user
        note:
          type: string
          maxLength: 2000
          description: Note content
        createdAt:
          type: string
          format: date-time

    OrderStatus:
      type: string
      enum:
        - new
        - submitted
        - paid
        - completed
        - cancelled

    UpdateOrderStatusRequest:
      type: object
      description: Request to update order status
      required:
        - status
      properties:
        status:
          $ref: '#/components/schemas/OrderStatus'
        notes:
          type: string
          maxLength: 1000
          description: Optional notes explaining the status change

    AddOrderNoteRequest:
      type: object
      description: Request to add admin note
      required:
        - note
      properties:
        note:
          type: string
          minLength: 1
          maxLength: 2000
          description: Note content

    RefundRequest:
      type: object
      description: Request to process refund
      required:
        - amount
        - reason
        - refundShipping
      properties:
        amount:
          type: number
          format: double
          minimum: 0.01
          description: Refund amount
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: Reason for refund
        refundShipping:
          type: boolean
          description: Whether to refund shipping cost

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
        message:
          type: string
        statusCode:
          type: integer
        details:
          type: object
          additionalProperties: true

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Authentication token is missing or invalid
            statusCode: 401

    ForbiddenError:
      description: Insufficient permissions (admin role required)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Forbidden
            message: Admin role required for this operation
            statusCode: 403

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal Server Error
            message: An unexpected error occurred
            statusCode: 500

security:
  - bearerAuth: []
