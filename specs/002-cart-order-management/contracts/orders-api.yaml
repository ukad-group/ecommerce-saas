openapi: 3.0.3
info:
  title: Customer Orders API
  description: |
    API for customers to view their order history, order details, status tracking,
    and request cancellations. Provides read access to submitted orders and limited
    write access for customer-initiated actions.
  version: 1.0.0
  contact:
    name: eCommerce SaaS API Team
    email: api@ecommerce-saas.com

servers:
  - url: http://localhost:5173/api/v1
    description: Development server with MSW mocks
  - url: https://api.ecommerce-saas.com/api/v1
    description: Production server (future)

tags:
  - name: Orders
    description: Customer order operations

paths:
  /orders:
    get:
      summary: Get customer's order history
      description: |
        Retrieves paginated list of orders for the authenticated customer.
        Only returns orders with status != 'new' (submitted orders, not active carts).
        Results can be filtered by status and are sorted by creation date (newest first).
      operationId: getOrders
      tags:
        - Orders
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: status
          in: query
          description: Filter by order status
          required: false
          schema:
            type: string
            enum:
              - submitted
              - paid
              - completed
              - cancelled
          example: paid
        - name: page
          in: query
          description: Page number (1-indexed)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          description: Number of results per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'
              example:
                orders:
                  - id: order-123e4567-e89b-12d3-a456-426614174000
                    tenantId: demo-tenant
                    customerId: customer-123
                    orderNumber: DEMO-000001
                    status: completed
                    subtotal: 89.97
                    tax: 7.20
                    shipping: 5.99
                    discount: 0
                    total: 103.16
                    currency: USD
                    isGuest: false
                    createdAt: '2025-10-20T10:00:00Z'
                    updatedAt: '2025-10-21T15:30:00Z'
                    submittedAt: '2025-10-20T10:30:00Z'
                    completedAt: '2025-10-21T15:30:00Z'
                  - id: order-987e6543-e21b-12d3-a456-426614174000
                    tenantId: demo-tenant
                    customerId: customer-123
                    orderNumber: DEMO-000002
                    status: paid
                    subtotal: 149.99
                    tax: 12.00
                    shipping: 5.99
                    discount: 15.00
                    total: 152.98
                    currency: USD
                    isGuest: false
                    createdAt: '2025-10-22T08:00:00Z'
                    updatedAt: '2025-10-22T08:15:00Z'
                    submittedAt: '2025-10-22T08:15:00Z'
                totalCount: 2
                page: 1
                limit: 20
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orders/{orderId}:
    get:
      summary: Get order details
      description: |
        Retrieves full details for a specific order including line items, addresses,
        status history, and payment transactions. Customer can only access their own orders.
      operationId: getOrderDetails
      tags:
        - Orders
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Order details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                tenantId: demo-tenant
                customerId: customer-123
                orderNumber: DEMO-000001
                status: completed
                subtotal: 89.97
                tax: 7.20
                shipping: 5.99
                discount: 0
                total: 103.16
                currency: USD
                isGuest: false
                createdAt: '2025-10-20T10:00:00Z'
                updatedAt: '2025-10-21T15:30:00Z'
                submittedAt: '2025-10-20T10:30:00Z'
                completedAt: '2025-10-21T15:30:00Z'
                lineItems:
                  - id: item-123
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    productId: prod-001
                    productName: Wireless Mouse
                    productSKU: WM-001
                    productImage: https://example.com/images/mouse.jpg
                    quantity: 2
                    unitPrice: 29.99
                    lineTotal: 59.98
                    currency: USD
                  - id: item-456
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    productId: prod-002
                    productName: USB Keyboard
                    productSKU: KB-002
                    productImage: https://example.com/images/keyboard.jpg
                    quantity: 1
                    unitPrice: 29.99
                    lineTotal: 29.99
                    currency: USD
                shippingAddress:
                  id: addr-123
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  firstName: John
                  lastName: Doe
                  addressLine1: 123 Main St
                  city: San Francisco
                  state: CA
                  postalCode: '94102'
                  country: US
                  phone: '+14155551234'
                billingAddress:
                  id: addr-456
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  firstName: John
                  lastName: Doe
                  addressLine1: 123 Main St
                  city: San Francisco
                  state: CA
                  postalCode: '94102'
                  country: US
                  phone: '+14155551234'
                  sameAsShipping: true
                statusHistory:
                  - id: hist-1
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: null
                    toStatus: new
                    timestamp: '2025-10-20T10:00:00Z'
                    notes: Cart created
                  - id: hist-2
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: new
                    toStatus: submitted
                    timestamp: '2025-10-20T10:30:00Z'
                    notes: Order submitted by customer
                  - id: hist-3
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: submitted
                    toStatus: paid
                    timestamp: '2025-10-20T10:31:00Z'
                    notes: Payment successful
                  - id: hist-4
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: paid
                    toStatus: completed
                    timestamp: '2025-10-21T15:30:00Z'
                    notes: Order fulfilled and shipped
                transactions:
                  - id: txn-123
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    amount: 103.16
                    currency: USD
                    paymentMethod: credit_card
                    paymentProvider: stripe
                    transactionId: ch_mock_12345
                    status: success
                    type: charge
                    createdAt: '2025-10-20T10:31:00Z'
                    processedAt: '2025-10-20T10:31:00Z'
        '403':
          description: Not customer's order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Forbidden
                message: You do not have access to this order
                statusCode: 403
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Order with ID order-999 not found
                statusCode: 404
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orders/{orderId}/status-history:
    get:
      summary: Get order status history
      description: |
        Retrieves the complete status history timeline for an order.
        Shows all status transitions with timestamps and notes.
      operationId: getOrderStatusHistory
      tags:
        - Orders
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Status history retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderStatusHistory'
              example:
                - id: hist-1
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  fromStatus: null
                  toStatus: new
                  timestamp: '2025-10-20T10:00:00Z'
                  notes: Cart created
                - id: hist-2
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  fromStatus: new
                  toStatus: submitted
                  timestamp: '2025-10-20T10:30:00Z'
                  notes: Order submitted by customer
                - id: hist-3
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  fromStatus: submitted
                  toStatus: paid
                  timestamp: '2025-10-20T10:31:00Z'
                  notes: Payment successful
                - id: hist-4
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  fromStatus: paid
                  toStatus: completed
                  timestamp: '2025-10-21T15:30:00Z'
                  notes: Order fulfilled and shipped
        '403':
          description: Not customer's order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Forbidden
                message: You do not have access to this order
                statusCode: 403
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Order with ID order-999 not found
                statusCode: 404
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orders/{orderId}/cancel:
    post:
      summary: Request order cancellation
      description: |
        Allows customer to request order cancellation. Cancellation is allowed
        for orders in 'submitted' status. Orders that are 'paid' or later require
        admin intervention. Creates a cancellation request and updates order status
        to 'cancelled' if allowed.
      operationId: cancelOrder
      tags:
        - Orders
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: orderId
          in: path
          required: true
          description: Unique order identifier
          schema:
            type: string
            format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderRequest'
            example:
              reason: Changed my mind about the purchase
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                tenantId: demo-tenant
                customerId: customer-123
                orderNumber: DEMO-000001
                status: cancelled
                subtotal: 89.97
                tax: 7.20
                shipping: 5.99
                discount: 0
                total: 103.16
                currency: USD
                isGuest: false
                createdAt: '2025-10-20T10:00:00Z'
                updatedAt: '2025-10-22T11:00:00Z'
                submittedAt: '2025-10-20T10:30:00Z'
                cancelledAt: '2025-10-22T11:00:00Z'
                cancellationReason: Changed my mind about the purchase
                statusHistory:
                  - id: hist-1
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: null
                    toStatus: new
                    timestamp: '2025-10-20T10:00:00Z'
                  - id: hist-2
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: new
                    toStatus: submitted
                    timestamp: '2025-10-20T10:30:00Z'
                  - id: hist-3
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    fromStatus: submitted
                    toStatus: cancelled
                    timestamp: '2025-10-22T11:00:00Z'
                    notes: Cancelled by customer - Changed my mind about the purchase
        '400':
          description: Cannot cancel order (invalid status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyShipped:
                  summary: Order already completed
                  value:
                    error: Bad Request
                    message: Cannot cancel order that has already been completed
                    statusCode: 400
                    details:
                      currentStatus: completed
                requiresAdmin:
                  summary: Paid order requires admin
                  value:
                    error: Bad Request
                    message: Order has been paid and requires admin approval to cancel. Please contact support.
                    statusCode: 400
                    details:
                      currentStatus: paid
        '403':
          description: Not customer's order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Forbidden
                message: You do not have access to this order
                statusCode: 403
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Order with ID order-999 not found
                statusCode: 404
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authenticated requests

  parameters:
    TenantIdHeader:
      name: X-Tenant-ID
      in: header
      required: true
      description: Unique identifier for the tenant (store)
      schema:
        type: string
        format: uuid
      example: demo-tenant

  schemas:
    OrderListResponse:
      type: object
      description: Paginated list of orders
      required:
        - orders
        - totalCount
        - page
        - limit
      properties:
        orders:
          type: array
          description: Array of order summaries
          items:
            $ref: '#/components/schemas/OrderSummary'
        totalCount:
          type: integer
          description: Total number of orders matching filters
          minimum: 0
          example: 25
        page:
          type: integer
          description: Current page number (1-indexed)
          minimum: 1
          example: 1
        limit:
          type: integer
          description: Number of results per page
          minimum: 1
          example: 20

    OrderSummary:
      type: object
      description: Order summary for list view
      required:
        - id
        - tenantId
        - customerId
        - orderNumber
        - status
        - total
        - currency
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: order-123e4567-e89b-12d3-a456-426614174000
        tenantId:
          type: string
          example: demo-tenant
        customerId:
          type: string
          format: uuid
          example: customer-123
        orderNumber:
          type: string
          example: DEMO-000001
        status:
          $ref: '#/components/schemas/OrderStatus'
        subtotal:
          type: number
          format: double
          example: 89.97
        tax:
          type: number
          format: double
          example: 7.20
        shipping:
          type: number
          format: double
          example: 5.99
        discount:
          type: number
          format: double
          example: 0
        total:
          type: number
          format: double
          example: 103.16
        currency:
          type: string
          example: USD
        isGuest:
          type: boolean
          example: false
        createdAt:
          type: string
          format: date-time
          example: '2025-10-20T10:00:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2025-10-21T15:30:00Z'
        submittedAt:
          type: string
          format: date-time
          example: '2025-10-20T10:30:00Z'
        completedAt:
          type: string
          format: date-time
          example: '2025-10-21T15:30:00Z'
        cancelledAt:
          type: string
          format: date-time
          example: '2025-10-22T11:00:00Z'

    OrderDetail:
      allOf:
        - $ref: '#/components/schemas/OrderSummary'
        - type: object
          properties:
            cancellationReason:
              type: string
              maxLength: 500
              example: Changed my mind about the purchase
            lineItems:
              type: array
              items:
                $ref: '#/components/schemas/OrderLineItem'
            shippingAddress:
              $ref: '#/components/schemas/Address'
            billingAddress:
              $ref: '#/components/schemas/BillingAddress'
            statusHistory:
              type: array
              items:
                $ref: '#/components/schemas/OrderStatusHistory'
            transactions:
              type: array
              items:
                $ref: '#/components/schemas/PaymentTransaction'

    OrderLineItem:
      type: object
      description: Order line item
      required:
        - id
        - orderId
        - productId
        - productName
        - productSKU
        - quantity
        - unitPrice
        - lineTotal
        - currency
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        productId:
          type: string
          format: uuid
        productName:
          type: string
        productSKU:
          type: string
        productImage:
          type: string
          format: uri
        quantity:
          type: integer
          minimum: 1
        unitPrice:
          type: number
          format: double
        lineTotal:
          type: number
          format: double
        currency:
          type: string

    Address:
      type: object
      description: Shipping or billing address
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        company:
          type: string
        addressLine1:
          type: string
        addressLine2:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string
        phone:
          type: string

    BillingAddress:
      allOf:
        - $ref: '#/components/schemas/Address'
        - type: object
          properties:
            sameAsShipping:
              type: boolean

    OrderStatusHistory:
      type: object
      description: Order status history entry
      required:
        - id
        - orderId
        - toStatus
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        fromStatus:
          $ref: '#/components/schemas/OrderStatus'
        toStatus:
          $ref: '#/components/schemas/OrderStatus'
        timestamp:
          type: string
          format: date-time
        userId:
          type: string
          format: uuid
          description: User who made the change (admin actions)
        userEmail:
          type: string
          format: email
          description: Email of user who made the change
        notes:
          type: string
          maxLength: 1000

    PaymentTransaction:
      type: object
      description: Payment transaction
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        amount:
          type: number
          format: double
        currency:
          type: string
        paymentMethod:
          type: string
          enum:
            - credit_card
            - debit_card
            - paypal
            - stripe
            - mock
        paymentProvider:
          type: string
        transactionId:
          type: string
        status:
          type: string
          enum:
            - pending
            - success
            - failed
            - refunded
        type:
          type: string
          enum:
            - charge
            - refund
        failureReason:
          type: string
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time

    OrderStatus:
      type: string
      description: Order status
      enum:
        - new
        - submitted
        - paid
        - completed
        - cancelled

    CancelOrderRequest:
      type: object
      description: Request to cancel order
      required:
        - reason
      properties:
        reason:
          type: string
          description: Reason for cancellation
          maxLength: 500
          example: Changed my mind about the purchase

    ErrorResponse:
      type: object
      description: Standard error response
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
        message:
          type: string
        statusCode:
          type: integer
        details:
          type: object
          additionalProperties: true

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Authentication token is missing or invalid
            statusCode: 401

    InternalServerError:
      description: Internal server error
      content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Internal Server Error
                message: An unexpected error occurred
                statusCode: 500

security:
  - bearerAuth: []
