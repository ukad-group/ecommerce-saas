openapi: 3.0.3
info:
  title: Checkout API
  description: |
    API for the checkout process including cart validation, address management,
    order submission, and payment processing. Handles the complete flow from
    cart (status='new') to paid order (status='paid').
  version: 1.0.0
  contact:
    name: eCommerce SaaS API Team
    email: api@ecommerce-saas.com

servers:
  - url: http://localhost:5173/api/v1
    description: Development server with MSW mocks
  - url: https://api.ecommerce-saas.com/api/v1
    description: Production server (future)

tags:
  - name: Checkout
    description: Checkout process operations

paths:
  /checkout/validate:
    post:
      summary: Validate cart before checkout
      description: |
        Validates the current cart to ensure all products are still available,
        in stock, and at the expected price. Returns validation result with
        any issues that need to be resolved before checkout can proceed.
      operationId: validateCheckout
      tags:
        - Checkout
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Validation completed (check 'valid' field for result)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutValidationResult'
              examples:
                valid:
                  summary: Cart is valid
                  value:
                    valid: true
                    issues: []
                priceChange:
                  summary: Product price changed
                  value:
                    valid: false
                    issues:
                      - type: price_change
                        message: Price for 'Wireless Mouse' has changed from $29.99 to $24.99
                        lineItemId: item-123
                        oldValue: 29.99
                        newValue: 24.99
                outOfStock:
                  summary: Product out of stock
                  value:
                    valid: false
                    issues:
                      - type: out_of_stock
                        message: 'USB Keyboard' is no longer available
                        lineItemId: item-456
                unavailable:
                  summary: Product discontinued
                  value:
                    valid: false
                    issues:
                      - type: product_unavailable
                        message: 'Gaming Headset' has been discontinued
                        lineItemId: item-789
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: No active cart found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: No active cart found
                statusCode: 404
        '500':
          $ref: '#/components/responses/InternalServerError'

  /checkout/shipping:
    post:
      summary: Set shipping address and get shipping options
      description: |
        Sets the shipping address for the order and returns available shipping
        options with costs and estimated delivery times. Address is validated
        and may be standardized.
      operationId: setShippingAddress
      tags:
        - Checkout
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShippingAddressInput'
            example:
              firstName: John
              lastName: Doe
              company: Acme Corp
              addressLine1: 123 Main St
              addressLine2: Apt 4B
              city: San Francisco
              state: CA
              postalCode: '94102'
              country: US
              phone: '+14155551234'
      responses:
        '200':
          description: Shipping address set successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShippingOptionsResponse'
              example:
                shippingAddressId: addr-123e4567-e89b-12d3-a456-426614174000
                shippingOptions:
                  - id: standard
                    name: Standard Shipping
                    cost: 5.99
                    estimatedDelivery: '2025-10-28'
                    carrier: USPS
                  - id: express
                    name: Express Shipping
                    cost: 15.99
                    estimatedDelivery: '2025-10-24'
                    carrier: FedEx
                  - id: overnight
                    name: Overnight Shipping
                    cost: 29.99
                    estimatedDelivery: '2025-10-23'
                    carrier: UPS
        '400':
          description: Invalid address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Invalid postal code format for country US
                statusCode: 400
                details:
                  field: postalCode
                  value: INVALID
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /checkout/billing:
    post:
      summary: Set billing address
      description: |
        Sets the billing address for payment processing. Can optionally use the
        same address as shipping by setting sameAsShipping=true.
      operationId: setBillingAddress
      tags:
        - Checkout
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingAddressInput'
            examples:
              differentAddress:
                summary: Different billing address
                value:
                  firstName: John
                  lastName: Doe
                  addressLine1: 456 Oak Ave
                  city: Los Angeles
                  state: CA
                  postalCode: '90001'
                  country: US
                  phone: '+13105551234'
                  sameAsShipping: false
              sameAsShipping:
                summary: Same as shipping address
                value:
                  sameAsShipping: true
      responses:
        '200':
          description: Billing address set successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingAddressResponse'
              example:
                billingAddressId: addr-987e6543-e21b-12d3-a456-426614174000
                success: true
        '400':
          description: Invalid address or missing shipping address when sameAsShipping=true
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidAddress:
                  summary: Invalid address format
                  value:
                    error: Bad Request
                    message: Phone number format is invalid
                    statusCode: 400
                    details:
                      field: phone
                noShippingAddress:
                  summary: No shipping address set
                  value:
                    error: Bad Request
                    message: Cannot use sameAsShipping=true when no shipping address is set
                    statusCode: 400
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /checkout/submit:
    post:
      summary: Submit order
      description: |
        Submits the order, transitioning from status='new' to status='submitted'.
        This locks the cart and prepares it for payment. Performs final validation
        of inventory and pricing.
      operationId: submitOrder
      tags:
        - Checkout
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitCheckoutRequest'
            example:
              shippingAddressId: addr-123e4567-e89b-12d3-a456-426614174000
              billingAddressId: addr-987e6543-e21b-12d3-a456-426614174000
              shippingOptionId: standard
      responses:
        '200':
          description: Order submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                tenantId: demo-tenant
                marketId: market-1
                orderNumber: DEMO-000001
                status: submitted
                subtotal: 89.97
                tax: 7.20
                shipping: 5.99
                discount: 0
                total: 103.16
                currency: USD
                createdAt: '2025-10-22T10:00:00Z'
                updatedAt: '2025-10-22T10:30:00Z'
                submittedAt: '2025-10-22T10:30:00Z'
                lineItems: []
                shippingAddress:
                  id: addr-123e4567-e89b-12d3-a456-426614174000
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  firstName: John
                  lastName: Doe
                  addressLine1: 123 Main St
                  city: San Francisco
                  state: CA
                  postalCode: '94102'
                  country: US
                  phone: '+14155551234'
                billingAddress:
                  id: addr-987e6543-e21b-12d3-a456-426614174000
                  orderId: order-123e4567-e89b-12d3-a456-426614174000
                  firstName: John
                  lastName: Doe
                  addressLine1: 123 Main St
                  city: San Francisco
                  state: CA
                  postalCode: '94102'
                  country: US
                  phone: '+14155551234'
                  sameAsShipping: true
        '400':
          description: Validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingAddress:
                  summary: Missing required addresses
                  value:
                    error: Bad Request
                    message: Shipping and billing addresses are required
                    statusCode: 400
                emptyCart:
                  summary: Cart is empty
                  value:
                    error: Bad Request
                    message: Cannot submit order with empty cart
                    statusCode: 400
        '404':
          description: Address or cart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Shipping address not found
                statusCode: 404
        '409':
          description: Inventory changed, cart invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Conflict
                message: Product 'Wireless Mouse' is out of stock
                statusCode: 409
                details:
                  productId: prod-001
                  availableQuantity: 0
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /checkout/payment:
    post:
      summary: Process payment
      description: |
        Processes payment for a submitted order, transitioning from status='submitted'
        to status='paid'. Creates a PaymentTransaction record. In production, integrates
        with payment gateway (Stripe, PayPal, etc.). In development/mock mode, simulates
        payment processing.
      operationId: processPayment
      tags:
        - Checkout
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequest'
            example:
              orderId: order-123e4567-e89b-12d3-a456-426614174000
              paymentMethodId: pm_mock_visa
              paymentDetails:
                cardNumber: '4242424242424242'
                cardExpiry: '12/25'
                cardCVV: '123'
                cardholderName: John Doe
      responses:
        '200':
          description: Payment processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
              example:
                id: order-123e4567-e89b-12d3-a456-426614174000
                tenantId: demo-tenant
                marketId: market-1
                orderNumber: DEMO-000001
                status: paid
                subtotal: 89.97
                tax: 7.20
                shipping: 5.99
                discount: 0
                total: 103.16
                currency: USD
                createdAt: '2025-10-22T10:00:00Z'
                updatedAt: '2025-10-22T10:31:00Z'
                submittedAt: '2025-10-22T10:30:00Z'
                transactions:
                  - id: txn-123e4567-e89b-12d3-a456-426614174000
                    orderId: order-123e4567-e89b-12d3-a456-426614174000
                    amount: 103.16
                    currency: USD
                    paymentMethod: credit_card
                    paymentProvider: stripe
                    transactionId: ch_mock_12345
                    status: success
                    type: charge
                    createdAt: '2025-10-22T10:31:00Z'
                    processedAt: '2025-10-22T10:31:00Z'
        '400':
          description: Invalid payment request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Order must be in 'submitted' status to process payment
                statusCode: 400
        '402':
          description: Payment failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                cardDeclined:
                  summary: Card declined
                  value:
                    error: Payment Required
                    message: Your card was declined
                    statusCode: 402
                    details:
                      transactionId: txn-failed-123
                      failureReason: card_declined
                insufficientFunds:
                  summary: Insufficient funds
                  value:
                    error: Payment Required
                    message: Insufficient funds
                    statusCode: 402
                    details:
                      transactionId: txn-failed-456
                      failureReason: insufficient_funds
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Not Found
                message: Order with ID order-999 not found
                statusCode: 404
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authenticated requests

  parameters:
    TenantIdHeader:
      name: X-Tenant-ID
      in: header
      required: true
      description: Unique identifier for the tenant
      schema:
        type: string
        format: uuid
      example: demo-tenant

  schemas:
    CheckoutValidationResult:
      type: object
      description: Result of checkout validation
      required:
        - valid
        - issues
      properties:
        valid:
          type: boolean
          description: Whether cart is valid for checkout
          example: true
        issues:
          type: array
          description: List of validation issues (empty if valid)
          items:
            $ref: '#/components/schemas/CheckoutValidationIssue'

    CheckoutValidationIssue:
      type: object
      description: Single validation issue
      required:
        - type
        - message
      properties:
        type:
          type: string
          description: Issue type
          enum:
            - out_of_stock
            - price_change
            - product_unavailable
          example: price_change
        message:
          type: string
          description: Human-readable issue description
          example: Price for 'Wireless Mouse' has changed from $29.99 to $24.99
        lineItemId:
          type: string
          format: uuid
          description: Affected line item ID
          example: item-123e4567-e89b-12d3-a456-426614174000
        oldValue:
          description: Previous value (for price_change)
          example: 29.99
        newValue:
          description: New value (for price_change)
          example: 24.99

    ShippingAddressInput:
      type: object
      description: Shipping address input
      required:
        - firstName
        - lastName
        - addressLine1
        - city
        - state
        - postalCode
        - country
        - phone
      properties:
        firstName:
          type: string
          maxLength: 100
          example: John
        lastName:
          type: string
          maxLength: 100
          example: Doe
        company:
          type: string
          maxLength: 100
          example: Acme Corp
        addressLine1:
          type: string
          maxLength: 200
          example: 123 Main St
        addressLine2:
          type: string
          maxLength: 200
          example: Apt 4B
        city:
          type: string
          maxLength: 100
          example: San Francisco
        state:
          type: string
          description: State/province code (2 characters for US states)
          example: CA
        postalCode:
          type: string
          description: ZIP/postal code
          example: '94102'
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          pattern: '^[A-Z]{2}$'
          example: US
        phone:
          type: string
          description: E.164 format phone number
          example: '+14155551234'

    ShippingOptionsResponse:
      type: object
      description: Shipping options response
      required:
        - shippingAddressId
        - shippingOptions
      properties:
        shippingAddressId:
          type: string
          format: uuid
          description: ID of saved shipping address
          example: addr-123e4567-e89b-12d3-a456-426614174000
        shippingOptions:
          type: array
          description: Available shipping options
          items:
            $ref: '#/components/schemas/ShippingOption'

    ShippingOption:
      type: object
      description: Shipping option with cost and delivery estimate
      required:
        - id
        - name
        - cost
        - estimatedDelivery
      properties:
        id:
          type: string
          description: Shipping option identifier
          example: standard
        name:
          type: string
          description: Display name
          example: Standard Shipping
        cost:
          type: number
          format: double
          description: Shipping cost
          minimum: 0
          example: 5.99
        estimatedDelivery:
          type: string
          format: date
          description: Estimated delivery date (ISO 8601)
          example: '2025-10-28'
        carrier:
          type: string
          description: Carrier name
          example: USPS

    BillingAddressInput:
      type: object
      description: Billing address input (same schema as shipping, plus sameAsShipping flag)
      properties:
        firstName:
          type: string
          maxLength: 100
          example: John
        lastName:
          type: string
          maxLength: 100
          example: Doe
        company:
          type: string
          maxLength: 100
        addressLine1:
          type: string
          maxLength: 200
          example: 456 Oak Ave
        addressLine2:
          type: string
          maxLength: 200
        city:
          type: string
          maxLength: 100
          example: Los Angeles
        state:
          type: string
          example: CA
        postalCode:
          type: string
          example: '90001'
        country:
          type: string
          pattern: '^[A-Z]{2}$'
          example: US
        phone:
          type: string
          example: '+13105551234'
        sameAsShipping:
          type: boolean
          description: Use shipping address for billing
          default: false
          example: false

    BillingAddressResponse:
      type: object
      description: Billing address response
      required:
        - billingAddressId
        - success
      properties:
        billingAddressId:
          type: string
          format: uuid
          description: ID of saved billing address
          example: addr-987e6543-e21b-12d3-a456-426614174000
        success:
          type: boolean
          description: Whether address was saved successfully
          example: true

    SubmitCheckoutRequest:
      type: object
      description: Request to submit order
      required:
        - shippingAddressId
        - billingAddressId
        - shippingOptionId
      properties:
        shippingAddressId:
          type: string
          format: uuid
          description: Shipping address to use
          example: addr-123e4567-e89b-12d3-a456-426614174000
        billingAddressId:
          type: string
          format: uuid
          description: Billing address to use
          example: addr-987e6543-e21b-12d3-a456-426614174000
        shippingOptionId:
          type: string
          description: Selected shipping option
          example: standard

    PaymentRequest:
      type: object
      description: Payment processing request
      required:
        - orderId
        - paymentMethodId
        - paymentDetails
      properties:
        orderId:
          type: string
          format: uuid
          description: Order to process payment for
          example: order-123e4567-e89b-12d3-a456-426614174000
        paymentMethodId:
          type: string
          description: Payment method identifier (from payment gateway)
          example: pm_mock_visa
        paymentDetails:
          type: object
          description: Payment details (mock only - real implementation uses tokenized data)
          required:
            - cardholderName
          properties:
            cardNumber:
              type: string
              description: Card number (mock only, never store in production)
              example: '4242424242424242'
            cardExpiry:
              type: string
              description: Card expiry (MM/YY format)
              example: '12/25'
            cardCVV:
              type: string
              description: Card CVV (mock only)
              example: '123'
            cardholderName:
              type: string
              description: Cardholder name
              example: John Doe

    Order:
      type: object
      description: Order entity (full schema in cart-api.yaml)
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
        marketId:
          type: string
        orderNumber:
          type: string
        status:
          type: string
          enum:
            - new
            - submitted
            - paid
            - completed
            - cancelled
        subtotal:
          type: number
          format: double
        tax:
          type: number
          format: double
        shipping:
          type: number
          format: double
        discount:
          type: number
          format: double
        total:
          type: number
          format: double
        currency:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/PaymentTransaction'
        shippingAddress:
          $ref: '#/components/schemas/Address'
        billingAddress:
          $ref: '#/components/schemas/Address'

    PaymentTransaction:
      type: object
      description: Payment transaction record
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        amount:
          type: number
          format: double
        currency:
          type: string
        paymentMethod:
          type: string
        paymentProvider:
          type: string
        transactionId:
          type: string
        status:
          type: string
          enum:
            - pending
            - success
            - failed
            - refunded
        type:
          type: string
          enum:
            - charge
            - refund
        failureReason:
          type: string
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time

    Address:
      type: object
      description: Address (shipping or billing)
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        company:
          type: string
        addressLine1:
          type: string
        addressLine2:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string
        phone:
          type: string
        sameAsShipping:
          type: boolean

    ErrorResponse:
      type: object
      description: Standard error response
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        statusCode:
          type: integer
          description: HTTP status code
        details:
          type: object
          description: Additional error details
          additionalProperties: true

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Authentication token is missing or invalid
            statusCode: 401

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal Server Error
            message: An unexpected error occurred
            statusCode: 500

security:
  - bearerAuth: []
